---
title: "samplesim: an R package for estimating sample size effects in stable isotope mixing solutions"
author: "Nicolas Casajus, Nicolas Lecomte and Dorothee Ehrich"
date: "`r Sys.Date()`"
lang: french
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{An introduction of the package samplesim}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!--

library(devtools)
setwd("/Users/nicolascasajus/Documents/samplesim")
devtools::build_vignettes()

-->


<style type = "text/css">
    body, p { line-height: 26px; font-size: 16px; }
    #TOC ul li, #TOC ul li ul li { line-height: 24px; font-size: 16px; list-style-type: none; }
    ul li, ul li ul li { list-style-type: disc; }
    h1 { margin-top:50px; color: #338c8c; font-size: 28px;}
    h2 { margin-top:25px; color: #338c8c; border-bottom-color: #338c8c; border-bottom-width: 2px; }
    h4 { font-size: 16px; }
    #TOC { margin-top: 25px; margin-bottom: 25px; }
    pre, code { font-size: 13px; line-height: 20px; }
    p { margin-top: 15px; }
    a { color: #338c8c; }
    p code, ul li code { color: #338c8c; font-weight: bold; }
</style>



<div style = "margin-top:50px;"></div>

This package allows the investigation of the effect of sample size on estimates and precision of stable isotope mixing solutions calculated with the package [**siar**](https://cran.r-project.org/web/packages/siar/index.html). Samples sizes are modified assuming a normal distribution with a user defined mean and standard deviation. Samples of different sizes are created from this distribution, and mixing proportions are estimated for several replicates of each sample size using the function `siar::siarmcmcdirchletv4()` and default values for the MCMC.


# Package installation


The **samplesim** package is hosted on the GitHub platform  ([github.com/ahasverus/samplesim](https://github.com/ahasverus/samplesim)). To install this package, you first need to install the **devtools** package from the CRAN. This package provides some useful functions such as the `install_github()` function which allows the installation of packages hosted in GitHub.


```{r, eval = FALSE, echo = TRUE}
# Install the < devtools > package
install.packages("devtools", dependencies = TRUE)

# Load the < devtools > package
library(devtools)

# Install the < samplesim > package from GitHub
devtools::install_github("ahasverus/samplesim", build_vignettes = TRUE)

# Load the < samplesim > package
library(samplesim)
```

```{r, eval = TRUE, echo = FALSE}
suppressMessages(library(samplesim))
```


Once the **samplesim** package is loaded in your working environment, you can type some useful command lines to get started.


```{r, eval = FALSE, echo = TRUE}
# List the content (objects and functions) of the < samplesim > package
ls("package:samplesim")

# Open the < samplesim > package home page
help(package = "samplesim")

# Open the help file of a specific function
help(plot_samplesim)

# Open the vignette (current document)
browseVignettes(package = "samplesim")
```


# Data description

Let's take a look at the data requirements. **samplesim** needs two type of data: one for the isotopic plasma values of the consumers (hereafter called `dataConsumer`) and one for the isotopic plasma values of the preys (hereafter called `dataPrey`).

Datasets provided in this package come from Killengreen _et al._ (2011)[^1]

[^1]: Killengreen S., Lecomte N., Ehrich D., Schott T., Yoccoz N.G. and Ims R.A. (2011) The importance of marine vs. human-induced subsidies in the maintenance of an expanding mesocarnivore in the arctic tundra. _Journal of Animal Ecology_, **80**, 1049-1060.


## Consumers data {#consumers}

The `dataConsumer` dataset contains the isotopic plasma values of the consumers over two isotopes. It must be structured in a data frame with at least two variables (one by isotope):

- `d13C`, describing the plasma values of the d13C isotope
- `d15N`, describing the plasma values of the d15N isotope

Each row of the data frame corresponds to one consumer. Let's import the `dataConsumer` dataset available in the **samplesim** package.

```{r, eval = TRUE, echo = TRUE}
# Import isotopic plasma values of the consumers
data(dataConsumer)

# Print the first ten rows
head(dataConsumer, 10)
```

- **Important:** make sure that column names are spelled such as in the above example.


## Preys data {#preys}

The `dataPrey` dataset contains the isotopic plasma values of the preys over two isotopes. It must be structured in a data frame with five variables :

- `Sources`, the name of the sources (preys or groups of preys)
- `Meand13C`, the mean values of the d13C isotope
- `SDd13C`, the standard deviation of the d13C isotope
- `Meand15N`, the mean values of the d15N isotope
- `SDd15N`, the standard deviation of the d15N isotope

Each row of the data frame corresponds to one source (prey or group of preys). Let's import the `dataPrey` dataset available in the **samplesim** package.

```{r, eval = TRUE, echo = TRUE}
# Import isotopic plasma values of the preys
data(dataPrey)

# Print the data frame content
dataPrey
```

- **Important:** make sure that column names are spelled such as in the above example.

In some case, your data might look like the consumers dataset, _i.e._ a data frame with the isotopic plasma values of each individual prey. Let's import the `dataRaw` dataset available in the **samplesim** package to illustrate this point.


```{r, eval = TRUE, echo = TRUE}
# Import raw isotopic plasma values of the preys
data(rawPrey)

# Print the first ten rows
head(rawPrey, 10)
```

The function `format_sources()` converts these raw data in the format of `dataPrey` by computing the mean and standard deviation of each isotope for each source. It is important to note that species can be grouped into sources (see below).

```{r, eval = TRUE, echo = TRUE}
# List species names
levels(rawPrey$Species)

# Group preys species into sources
(src <- list(
  Marine    = c("Ristri", "Urilom"),
  Reindeer  = c("Rantar"),
  Voles     = c("Micoec"),
  Lemming   = c("Lemlem"),
  Ptarmigan = c("Laglag", "Lagmut"),
  Birds     = c("Melnig")))

# Format preys data
(dataPrey <- format_sources(data = rawPrey, labels = src))
```

- **Note:** even if preys species do not have to be grouped, their labels need to be stored in a list. For example:

```{r, eval = TRUE, echo = TRUE}
# Prey species names
(species <- c("Marine", "Birds", "Voles"))

# R List conversion
(src <- as.list(species))

# Name elements of the list
names(src) <- species

# Print list
src
```


# Running samplesim

Make sure your data have the following format and the same column names:

- Consumer dataset

```{r, eval = TRUE, echo = FALSE}
head(dataConsumer)
```

- Prey dataset

```{r, eval = TRUE, echo = FALSE}
head(dataPrey)
```

The core function of **samplesim** is `samplesim()`. It allows investigating the effect of sample size on estimates and precision of stable isotope mixing solutions. More specifically `samplesim()` assesses the sensitivity of isotopes mixing models to variation in numbers of samples from source tissues. This tool can be used prior to full-blown studies in a similar manner than power analyses. It used the function `siar::siarmcmcdirichletv4()` developed by Andrew Parnell and available in the package **siar**. User can choose to sample one particular source, or all the sources. User can also choose to modify consumer data. Sample sizes are modified assuming a normal distribution with a user defined mean and standard deviation. Samples of different sizes are created from this distribution, and mixing proportions are estimated for several replicates of each sample size.

The general writing of `samplesim()` is:

```{r, eval = FALSE, echo = TRUE}
samplesim(
  target,
  sources,
  type = NULL,
  nsamples = NULL,
  modwhich = NULL,
  correct = NULL,
  nrep = 100,
  interval = 90,
  name = NULL)
```

with:

- `target`, the consumers dataset ([see Consumers data section](#consumers)).
- `sources`, the preys dataset ([see Preys data section](#preys)).
- `type`, the type of analysis to be run. Must be one of `one source`, `all sources` or `consumer`.
- `nsamples`, the sample sizes to simulate.
- `modwhich`, an integer indicating which source has to be modified.
- `correct`, [optional] a data frame with discrimination values. See [**siar**](https://cran.r-project.org/web/packages/siar/index.html) for further details.
- `nrep`, the number of replicates for each sample sizes.
- `interval`, an integer indicating the width of credible interval to use for precision estimation.
- `name`, the name of the simulation. If `NULL` the simulation will be named by the time of the simulation. This name will serve to create a directory in which results will be stored.

Let's take an example. We will assess the impact of the sample size of one source: the source \#3 (_Voles_) with several sample sizes (from 2 to 250). The analysis will be repeated 500 times.

```{r, eval = FALSE, echo = TRUE, message = FALSE}
# samplesim run for one source
samplesim(
  target = dataConsumer,
  source = dataPrey,
  type = "one source",
  modwhich = 3,
  nsamples = c(2:10, 15, 25, 50, 75, 100, 250),
  nrep = 500,
  interval = 90,
  name = "simulation_1")
```

This function does not return any object in the R console. Instead, results are stored in the directory `simulation_1` and they will need to be imported for results visualization ([see below section](#results)).

- **Note:** if you want to estimate sample size impacts of all sources, you need to set `type = "all source"`. If you want to assess the impact of the sample size of consumers, you have to set `type = "consumer"`.


# Results extraction {#results}

The `samplesim()` function has stored four objects results.

```{r, eval = TRUE, echo = TRUE}
# Content of the new directory (results)
dir("simulation_1")
```

- `intervals`, a four dimensions array with the upper and lower bounds of the credible interval for each sample size, replicate and source. First dimension represents lower and upper bounds; second dimension corresponds to the number of sources; third dimension is the number of replicates; and fourth dimension is the number of sample size.

- `widths`, a three dimensions array with the width (precision) of credible intervals for each source, each replicate and each sample size. First dimension corresponds to the number of replicates; second dimension is the number of sources; and third dimension represents the number of sample size.

- `medians`, a three dimensions array with the median (estimate) of credible intervals for each source, each replicate and each sample size. Dimensions are the same as for `widths` object.

- `datasets`, a four dimensions array with all resampled datasets.

A `logfile` is also written and contains all parameters of the simulation. Here's what it looks like.

```{r, echo = FALSE, eval = TRUE}
# Import medians of credible intervals
log <- readLines("simulation_1/logfile.txt")
cat(paste0(log, collapse = "\n"))
```


Now, let's take a look at the results and import the `medians` dataset using the R function `readRDS()`.

```{r, echo = TRUE, eval = TRUE}
# Import medians of credible intervals
medians <- readRDS("simulation_1/medians.rds")
```

```{r, echo = TRUE, eval = TRUE}
# Structure of the object
class(medians)

# Names of the dimensions
names(dimnames(medians))

# Names of the content of the second dimension
dimnames(medians)[[2]]

# Names of the content of the third dimension
dimnames(medians)[[3]]
```

These data are structured in a three dimensions array.

```{r, echo = TRUE, eval = TRUE}
# Extract results of the first replicate
medians[1, , ]

# Compute mean over replicates
apply(medians, 3:2, mean)
```

The structure of the `widths` dataset is the same as for `medians`.

If you are uncomfortable to deal with three dimensions arrays, you can use the function `get_output()` of the **samplesim** package. This function converts these two arrays (i.e. `medians` and `widths`) into an unique data frame.
For instance:

```{r, echo = TRUE, eval = TRUE}
# Import medians and widths of credible intervals
datas <- get_output("simulation_1")

# Structure of the data frame
str(datas)

# Print the first ten and last ten rows
rbind(head(datas, 10), tail(datas, 10))
```

If you want to select only the `widths` data,

```{r, echo = TRUE, eval = TRUE}
# Import medians of credible intervals
widths <- datas[datas$type == "Width of credible intervals", ]

# Check
rbind(head(widths, 10), tail(widths, 10))
```

The argument _change_ of the function `get_output()` allows to compute the percentage of change of medians and widths respectively, based on a value of sample size (argument _reference_; default is the minimum sample size). For instance,

```{r, echo = TRUE, eval = TRUE}
# Import medians and widths of credible intervals expressed as percentage of change
datas <- get_output("simulation_1", change = TRUE, reference = 2)

# Structure of the data frame
str(datas)

# Print the first ten and last ten rows
rbind(head(datas, 10), tail(datas, 10))
```

Here we notice that the column replicate is omitted and percentages of change are aggregated over replicates.

# Results visualization

The **samplesim** package also offers the possibility of visualizing the effect of sample size on the width of the credible interval and on the median of the posterior distribution of the mixing models. This is possible with the function `plot_samplesim()`.


```{r, echo = TRUE, eval = TRUE, fig.width = 7.1, fig.height = 4.5}
# Visualize results
plot_samplesim(name = "simulation_1")
```

If you prefer you can represent the percentages of change:

```{r, echo = TRUE, eval = TRUE, fig.width = 7.1, fig.height = 4.5}
# Visualize results expressed as percentages of change
plot_samplesim(name = "simulation_1", change = TRUE, reference = 2)
```

Finally, if you are not satisfied with the quality of the graph, you can customized it by 1) importing data and 2) programming your own graph. Let's take an example with the [**ggplot2**](https://cran.r-project.org/web/packages/ggplot2/index.html) package (used in **samplesim**).

```{r, echo = TRUE, eval = TRUE, fig.width = 7.1, fig.height = 4.5}
# Import medians and widths of credible intervals
datas <- get_output("simulation_1")

# Reminder #1
head(datas)

# Reminder #2
tail(datas)

# Graph
ggplot(aes(x = size, y = value), data = datas) +
  geom_boxplot(aes(fill = source), width = 0.8, outlier.shape = NA) +
  labs(x = "Sample size", y = "Values", fill = "Sources") +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) +
  facet_grid(. ~ type)
```

Or your can only represent the medians values. For instance (with percentages of change):


```{r, echo = TRUE, eval = TRUE, fig.width = 7.1, fig.height = 4.5}
# Import medians and widths of credible intervals
datas <- get_output("simulation_1", change = TRUE)

# Select medians of credible intervals
medians <- datas[datas$type == "Median of posterior distribution", ]

# Print data
head(medians)

# Graph
ggplot(aes(x = size, y = value, group = source), data = medians) +
  geom_point(aes(color = source)) +
  geom_line(aes(color = source)) +
  labs(x = "Sample size", y = "Change in medians (%)", color = "Sources") +
  theme_light() +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank())
```


# Reference {-}

Lecomte N., Ehrich D., Casajus N., Berteaux D., Giroux M.-A. and Yoccoz N.G. <span style = "color: #338c8c;">How many is enough? An R package for evaluating the effect of sample size on estimates and precision of stable isotope mixing solutions</span>. _Methods in Ecology and Evolution_, submitted.


<div style = "margin-bottom:50px;"></div>
